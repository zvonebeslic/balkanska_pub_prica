<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8">
  <title>Testiraj svoje znanje | Balkan Pub Quiz Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- SEO osnovno -->
  <meta name="description" content="Testiraj svoje znanje blitz i story pub kviz pitanjima. Biraj mod, uključi štopericu i igraj sam ili s ekipom.">
  <link rel="canonical" href="https://zvonebeslic.github.io/testiraj.html">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Testiraj svoje znanje – Balkan Pub Quiz Map">
  <meta property="og:description" content="Blitz i story pub kviz pitanja s Balkana – 60 i 90 sekundi, ili bez vremena.">
  <meta property="og:url" content="https://zvonebeslic.github.io/testiraj.html">
  <meta property="og:image" content="https://images.pexels.com/photos/301692/pexels-photo-301692.jpeg?auto=compress&cs=tinysrgb&w=1200">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Testiraj svoje znanje – Balkan Pub Quiz Map">
  <meta name="twitter:description" content="Probaj blitz kviz u 60 sekundi ili story kviz u 90 sekundi.">
  <meta name="twitter:image" content="https://images.pexels.com/photos/301692/pexels-photo-301692.jpeg?auto=compress&cs=tinysrgb&w=1200">

  <style>
    *,
    *::before,
    *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg-main: #120b07;
      --bg-wood: #3b2414;
      --bg-card: rgba(20, 10, 5, 0.94);
      --accent: #f5c15b;
      --accent-soft: #c07a2b;
      --accent-red: #ff6b6b;
      --accent-green: #7fd95b;
      --accent-blue: #5fb6ff;
      --text-main: #f9efe0;
      --text-muted: #c7b7a3;
      --border-soft: rgba(250, 245, 230, 0.18);
      --shadow-soft: 0 25px 60px rgba(0, 0, 0, 0.9);
    }

    html, body { height: 100%; }
    html { scroll-behavior: smooth; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top left, rgba(255, 250, 220, 0.08), transparent 60%),
        radial-gradient(circle at bottom right, rgba(255, 200, 150, 0.08), transparent 60%),
        url("https://images.pexels.com/photos/301692/pexels-photo-301692.jpeg?auto=compress&cs=tinysrgb&w=1600") center/cover fixed,
        var(--bg-main);
      color: var(--text-main);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      min-height: 100svh;
    }

    @supports (height: 100dvh) { body { min-height: 100dvh; } }

    @media (max-width: 768px) { body { background-attachment: scroll; } }

    .site-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.9rem 1.2rem;
      background: linear-gradient(135deg, #1d1209, #381f12);
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
    }

    .logo-wrap { display: flex; align-items: center; gap: 0.8rem; }

    .logo-icon {
      width: 42px; height: 42px; border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #ffe8a3, #e59f33);
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 12px rgba(245, 193, 91, 0.7), 0 0 30px rgba(245, 193, 91, 0.2);
      overflow: hidden;
    }

    .logo-icon img { width: 100%; height: 100%; object-fit: cover; border-radius: inherit; }

    .logo-text { display: flex; flex-direction: column; line-height: 1.1; }
    .logo-main { font-weight: 700; letter-spacing: 0.05em; text-transform: uppercase; font-size: 1rem; }
    .logo-sub { font-size: 0.75rem; color: var(--text-muted); }

    .top-nav { display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: flex-end; align-items: center; }

    .nav-btn {
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: transparent;
      color: var(--text-main);
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      transition: background 0.15s ease, transform 0.1s ease, border-color 0.15s ease;
      text-decoration: none;
    }

    .nav-btn--primary {
      background: radial-gradient(circle at 30% 20%, #ffe8a3, var(--accent-soft));
      color: #2b1608;
      border-color: rgba(255, 220, 160, 0.7);
      font-weight: 600;
    }

    .nav-btn:hover { transform: translateY(-1px); background: rgba(255, 255, 255, 0.04); }
    .nav-btn--primary:hover { background: radial-gradient(circle at 30% 20%, #fff0c4, #e19122); }

    .page-wrap {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
      padding: 1.2rem;
      gap: 1rem;
    }

    .quiz-hero {
      background: radial-gradient(circle at top, rgba(255, 240, 210, 0.1), rgba(0, 0, 0, 0.96));
      border-radius: 20px;
      padding: 1rem 1.2rem;
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      display: grid;
      grid-template-columns: 1.6fr 1.2fr;
      gap: 1rem;
      align-items: center;
      backdrop-filter: blur(12px);
    }

    .quiz-hero-main-title {
      font-size: 1.4rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      margin-bottom: 0.35rem;
    }

    .quiz-hero-subtitle { font-size: 0.95rem; color: var(--text-muted); margin-bottom: 0.6rem; }

    .quiz-hero-badges { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-bottom: 0.6rem; }

    .badge {
      font-size: 0.75rem;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(0, 0, 0, 0.5);
      color: var(--text-muted);
    }

    .badge--accent {
      background: rgba(245, 193, 91, 0.12);
      border-color: rgba(245, 193, 91, 0.8);
      color: var(--accent);
      font-weight: 500;
    }

    .mode-pills { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-bottom: 0.4rem; }

    .mode-pill {
      border-radius: 999px;
      padding: 0.4rem 0.8rem;
      font-size: 0.8rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(0, 0, 0, 0.5);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      color: var(--text-main);
      transition: background 0.15s ease, transform 0.1s ease, border-color 0.15s ease;
    }

    .mode-pill span.mode-label { font-weight: 600; }
    .mode-pill span.mode-desc { font-size: 0.75rem; color: var(--text-muted); }

    .mode-pill.active {
      background: radial-gradient(circle at 20% 0, #ffe8a3, var(--accent-soft));
      color: #2b1608;
      border-color: rgba(255, 222, 180, 0.9);
      transform: translateY(-1px);
      box-shadow: 0 0 10px rgba(245, 193, 91, 0.7);
    }

    .mode-pill.active span.mode-desc { color: #3e2410; }

    /* --- Tematski kvizovi UI --- */
    .themed-row { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; margin-top: 0.45rem; }
    .themed-btn {
      border-radius: 999px;
      padding: 0.45rem 0.95rem;
      font-size: 0.82rem;
      border: 1px solid rgba(255, 255, 255, 0.22);
      background: rgba(0, 0, 0, 0.45);
      color: var(--text-main);
      cursor: pointer;
      transition: background 0.15s ease, transform 0.1s ease, border-color 0.15s ease;
      display: inline-flex;
      gap: 0.4rem;
      align-items: center;
    }
    .themed-btn:hover { background: rgba(255, 255, 255, 0.06); transform: translateY(-1px); }
    .themed-btn.active {
      background: rgba(245, 193, 91, 0.12);
      border-color: rgba(245, 193, 91, 0.7);
      box-shadow: 0 0 10px rgba(245, 193, 91, 0.25);
    }
    .themed-panel {
      margin-top: 0.5rem;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(0, 0, 0, 0.55);
      padding: 0.6rem;
      display: none;
    }
    .themed-panel.open { display: block; }
    .themed-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.45rem;
    }
    .themed-topic {
      border-radius: 14px;
      padding: 0.5rem 0.65rem;
      font-size: 0.82rem;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(0, 0, 0, 0.35);
      color: var(--text-main);
      cursor: pointer;
      transition: background 0.15s ease, transform 0.1s ease, border-color 0.15s ease;
      text-align: left;
    }
    .themed-topic:hover { background: rgba(255, 255, 255, 0.05); transform: translateY(-1px); }
    .themed-topic.active {
      background: rgba(245, 193, 91, 0.14);
      border-color: rgba(245, 193, 91, 0.75);
      color: var(--accent);
      font-weight: 600;
    }
    .themed-hint { font-size: 0.78rem; color: var(--text-muted); margin-top: 0.4rem; }

    .hero-right-card {
      background: rgba(0, 0, 0, 0.8);
      border-radius: 18px;
      border: 1px solid var(--border-soft);
      padding: 0.8rem;
      font-size: 0.82rem;
      color: var(--text-muted);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(10px);
    }

    .hero-right-card h3 { font-size: 0.9rem; margin-bottom: 0.4rem; color: var(--text-main); }

    .hero-right-list { list-style: none; display: flex; flex-direction: column; gap: 0.25rem; }
    .hero-right-list li::before { content: "• "; color: var(--accent); }

    .quiz-main-grid {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(260px, 1.2fr);
      gap: 1rem;
      align-items: flex-start;
    }

    .quiz-card {
      background: var(--bg-card);
      border-radius: 18px;
      padding: 0.9rem;
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(14px);
      min-height: 320px;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .quiz-card-header { display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; }

    .quiz-card-title-block { display: flex; flex-direction: column; gap: 0.15rem; }

    .quiz-card-title { font-size: 0.95rem; text-transform: uppercase; letter-spacing: 0.03em; }
    .quiz-card-subtitle { font-size: 0.8rem; color: var(--text-muted); }

    .timer-pill {
      min-width: 90px;
      text-align: right;
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.95rem;
      padding: 0.35rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      background: rgba(0, 0, 0, 0.6);
      display: inline-flex;
      justify-content: flex-end;
      gap: 0.35rem;
      align-items: center;
    }

    .timer-label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); }
    .timer-value { font-weight: 600; }

    .question-image {
      width: 100%;
      max-height: 210px;
      border-radius: 14px;
      object-fit: cover;
      margin-top: 0.4rem;
      border: 1px solid rgba(255, 255, 255, 0.12);
    }

    .question-text-wrap { margin-top: 0.4rem; }
    .question-text-label { font-size: 0.78rem; color: var(--text-muted); margin-bottom: 0.15rem; }
    .question-text { font-size: 0.95rem; line-height: 1.4; }

    .question-meta { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem; }
    .question-meta span { margin-right: 0.4rem; }

    .question-meta .difficulty-pill {
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      font-size: 0.7rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      padding: 0.45rem 1.1rem;
      font-size: 0.85rem;
      cursor: pointer;
      background: rgba(0, 0, 0, 0.4);
      color: var(--text-main);
      transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease, opacity 0.12s ease;
      text-decoration: none;
    }

    .btn:disabled { opacity: 0.45; cursor: default; transform: none; box-shadow: none; }

    .btn--accent {
      background: radial-gradient(circle at 20% 0, #ffe8a3, var(--accent-soft));
      border-color: rgba(255, 222, 180, 0.9);
      color: #2b1608;
      font-weight: 600;
      box-shadow: 0 0 12px rgba(245, 193, 91, 0.6);
    }

    .btn--accent:hover:not(:disabled) {
      background: radial-gradient(circle at 20% 0, #fff2c6, #e18b1d);
      transform: translateY(-1px);
      box-shadow: 0 0 18px rgba(245, 193, 91, 0.8);
    }

    .btn--ghost { border-color: rgba(255, 255, 255, 0.22); }
    .btn--ghost:hover:not(:disabled) { background: rgba(255, 255, 255, 0.05); transform: translateY(-1px); }

    .btn--small { padding: 0.3rem 0.9rem; font-size: 0.8rem; }
    .btn-start-inline { margin-top: 0.6rem; }

    .answer-wrap { margin-top: 0.6rem; display: flex; flex-direction: column; gap: 0.4rem; }

    .answer-input-row { display: flex; gap: 0.4rem; align-items: center; }

    .answer-input-row input[type="text"] {
      flex: 1;
      border-radius: 16px;
      border: 2px solid rgba(255, 255, 255, 0.35);
      background: rgba(0, 0, 0, 0.65);
      padding: 0.65rem 1.1rem;
      color: var(--text-main);
      font-size: 1rem;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.7);
      outline: none;
    }

    .answer-input-row input[type="text"]::placeholder { color: rgba(255, 255, 255, 0.45); }

    .answer-input-row input[type="text"]:focus {
      border-color: rgba(245, 193, 91, 0.9);
      box-shadow: 0 0 18px rgba(245, 193, 91, 0.7);
    }

    .btn--icon { padding-inline: 1rem; font-size: 1.25rem; }

    .answer-feedback { font-size: 0.8rem; min-height: 1.1em; }
    .answer-feedback.correct { color: var(--accent-green); }
    .answer-feedback.incorrect { color: var(--accent-red); }

    .control-row { display: flex; justify-content: space-between; margin-top: 0.4rem; gap: 0.4rem; flex-wrap: wrap; }
    .control-row-left, .control-row-right { display: flex; gap: 0.4rem; flex-wrap: wrap; align-items: center; }

    .sidebar-card {
      background: var(--bg-card);
      border-radius: 18px;
      padding: 0.85rem 0.8rem;
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(14px);
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      max-height: 480px;
    }

    .sidebar-card h2 { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.03em; }

    .score-summary { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; }
    .score-summary-main { font-size: 1rem; font-weight: 600; }

    .score-summary-badges { display: flex; gap: 0.3rem; flex-wrap: wrap; font-size: 0.75rem; }

    .score-badge {
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(0, 0, 0, 0.5);
    }

    .score-badge--green { color: var(--accent-green); border-color: rgba(127, 217, 91, 0.7); }
    .score-badge--red { color: var(--accent-red); border-color: rgba(255, 107, 107, 0.7); }

    .history-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      overflow-y: auto;
      padding-right: 0.2rem;
      font-size: 0.78rem;
      -webkit-overflow-scrolling: touch;
    }

    .history-item {
      border-radius: 10px;
      padding: 0.35rem 0.45rem;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(0, 0, 0, 0.5);
    }

    .history-item.correct { border-color: rgba(127, 217, 91, 0.6); }
    .history-item.incorrect { border-color: rgba(255, 107, 107, 0.6); }

    .history-q { font-weight: 500; margin-bottom: 0.1rem; }

    .history-meta {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 0.1rem;
      gap: 0.5rem;
    }

    .history-a { font-size: 0.76rem; }
    .history-a span.label { color: var(--text-muted); }

    .site-footer {
      text-align: center;
      padding: 0.9rem 0.9rem 1rem;
      font-size: 0.78rem;
      color: var(--text-muted);
      background: linear-gradient(180deg, transparent, rgba(0, 0, 0, 0.85));
      margin-top: 0.4rem;
    }

    .footer-copy { font-size: 0.76rem; color: var(--text-muted); }

    @media (max-width: 900px) { .quiz-hero { grid-template-columns: 1fr; } }

    @media (max-width: 768px) {
      .site-header { flex-direction: column; align-items: flex-start; gap: 0.45rem; padding: 0.7rem 0.7rem; }
      .top-nav { width: 100%; justify-content: flex-start; flex-wrap: wrap; row-gap: 0.35rem; }
      .page-wrap { padding: 0.7rem; }
      .quiz-main-grid { grid-template-columns: 1fr; }
      .sidebar-card { max-height: none; }
      .themed-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<header class="site-header">
  <div class="logo-wrap">
    <div class="logo-icon">
      <img src="images/pub_kviz_logo.jpg" alt="Balkan Pub Quiz logo">
    </div>
    <div class="logo-text">
      <span class="logo-main">Balkanska Kviz Priča</span>
      <span class="logo-sub">Testiraj svoje znanje</span>
    </div>
  </div>
  <nav class="top-nav">
    <a href="index.html" class="nav-btn nav-btn--secondary">← Natrag na kartu</a>
    <a href="testiraj.html" class="nav-btn nav-btn--primary">Testiraj svoje znanje</a>
  </nav>
</header>

<main class="page-wrap">
  <section class="quiz-hero">
    <div>
      <h1 class="quiz-hero-main-title">Testiraj svoje znanje</h1>
      <p class="quiz-hero-subtitle">
        Blitz pitanja za brze reflekse ili duža, story pitanja za prave pub kviz znalce.
        Odaberi mod, pa započni kviz u prozoru s pitanjem.
      </p>

      <div class="quiz-hero-badges">
        <span class="badge badge--accent">Blitz 60s</span>
        <span class="badge badge--accent">Story 90s</span>
        <span class="badge badge--accent">Bez vremena</span>
        <span class="badge">Pitanja označena težinom 1–5</span>
      </div>

      <div class="mode-pills" id="mode-pills">
        <button class="mode-pill active" data-mode="blitz60">
          <span class="mode-label">Blitz 60s</span>
          <span class="mode-desc">jedno kratko pitanje za drugim</span>
        </button>
        <button class="mode-pill" data-mode="story90">
          <span class="mode-label">Story 90s</span>
          <span class="mode-desc">duža pitanja kao na pub kvizu</span>
        </button>
        <button class="mode-pill" data-mode="relax">
          <span class="mode-label">Bez vremena</span>
          <span class="mode-desc">random mix blitz + story</span>
        </button>
      </div>

      <!-- ✅ NOVO: Tematski kvizovi -->
      <div class="themed-row">
        <button class="themed-btn" id="btn-themed" type="button">Tematski kvizovi</button>
        <span class="badge" id="themed-active-badge" style="display:none;">Tema: <strong id="themed-active-name"></strong></span>
      </div>

      <div class="themed-panel" id="themed-panel">
        <div class="themed-grid" id="themed-grid">
          <button class="themed-topic" data-topic="HarryPotter" type="button">Harry Potter kviz</button>
          <button class="themed-topic" data-topic="LOTR" type="button">L.O.T.R. kviz</button>
          <button class="themed-topic" data-topic="PiratiSKariba" type="button">Pirati s Kariba kviz</button>
          <button class="themed-topic" data-topic="VolimHrvatsku" type="button">Volim Hrvatsku kviz</button>
          <button class="themed-topic" data-topic="VolimBiH" type="button">Volim BiH kviz</button>
          <button class="themed-topic" data-topic="VolimSrbiju" type="button">Volim Srbiju kviz</button>
          <button class="themed-topic" data-topic="AntickaGrcka" type="button">Antička Grčka kviz</button>
          <button class="themed-topic" data-topic="AntickiEgipat" type="button">Antički Egipat kviz</button>
          <button class="themed-topic" data-topic="AntickiRim" type="button">Antički Rim kviz</button>
          <button class="themed-topic" data-topic="AmerickiPredsjednici" type="button">Američki predsjednici kviz</button>
        </div>
        <div class="themed-hint">
          U tematskom kvizu dobivaš <strong>samo pitanja odabrane teme</strong>.
          U ostalim modovima teme se i dalje mogu pojavljivati normalno.
        </div>
      </div>
    </div>

    <aside class="hero-right-card">
      <h3>Kako funkcionira?</h3>
      <ul class="hero-right-list">
        <li>Odaberi mod (Blitz 60s, Story 90s ili Bez vremena).</li>
        <li>Pitanja su označena težinom 1–5, ali dolaze pomiješano.</li>
        <li>U timed modovima vrijeme se jednom kratko pauzira kad kreneš pisati odgovor.</li>
        <li>Svaki odgovor označava se zeleno/crveno i bilježi u desni panel.</li>
        <li>Možeš preskočiti pitanje ako ne znaš odgovor.</li>
        <li>Kad vrijeme istekne, završavaš taj kviz i pokrećeš novi.</li>
      </ul>
    </aside>
  </section>

  <section class="quiz-main-grid">
    <section class="quiz-card" id="quiz-card">
      <header class="quiz-card-header">
        <div class="quiz-card-title-block">
          <h2 class="quiz-card-title" id="quiz-title">Blitz kviz</h2>
          <p class="quiz-card-subtitle" id="quiz-mode-label">Brza pitanja u 60 sekundi</p>
        </div>
        <div class="timer-pill" id="timer-pill">
          <span class="timer-label">Vrijeme</span>
          <span class="timer-value" id="timer-value">60.0</span>
        </div>
      </header>

      <div class="question-container">
        <img src="" alt="" id="question-image" class="question-image" style="display:none;">
        <div class="question-text-wrap">
          <div class="question-text-label">Pitanje:</div>
          <div class="question-text" id="question-text">
            Klikni <strong>“Kreni s kvizom”</strong> ispod kako bi započeo igru.
          </div>
          <div class="question-meta" id="question-meta">
            <span id="question-type-label">Tip: —</span>
            <span class="difficulty-pill" id="question-difficulty-pill">Težina —/5</span>
          </div>
        </div>
      </div>

      <button class="btn btn--accent btn--small btn-start-inline" id="btn-start">Kreni s kvizom</button>

      <div class="answer-wrap">
        <div class="answer-input-row">
          <input type="text" id="answer-input" placeholder="Upiši svoj odgovor..." autocomplete="off">
          <button class="btn btn--accent btn--icon" id="btn-submit-answer" title="Potvrdi odgovor">✔</button>
        </div>
        <div class="answer-feedback" id="answer-feedback"></div>
      </div>

      <div class="control-row">
        <div class="control-row-left">
          <button class="btn btn--ghost btn--small" id="btn-skip">Preskoči pitanje</button>
        </div>
        <div class="control-row-right">
          <button class="btn btn--ghost btn--small" id="btn-reset">Reset kviza</button>
        </div>
      </div>
    </section>

    <aside class="sidebar-card">
      <h2>Rezultati & povijest</h2>
      <div class="score-summary">
        <div>
          <div class="score-summary-main"><span id="score-correct">0</span>/<span id="score-total">0</span> točnih</div>
          <div style="font-size:0.75rem; color:var(--text-muted);" id="score-percent">0% uspješnosti</div>
        </div>
        <div class="score-summary-badges">
          <span class="score-badge score-badge--green">✓ <span id="score-correct-small">0</span></span>
          <span class="score-badge score-badge--red">✗ <span id="score-wrong-small">0</span></span>
        </div>
      </div>

      <ul class="history-list" id="history-list"></ul>
    </aside>
  </section>
</main>

<footer class="site-footer">
  <p class="footer-copy">© <span id="year"></span> Balkanska Kviz Priča – Testiraj svoje znanje.</p>
</footer>

<script>
  /* ------------------ GLOBAL STATE ------------------ */

  const QUESTIONS_URL_BLITZ = "questions-blitz.json";
  const QUESTIONS_URL_STORY = "questions-story.json";
  const QUESTIONS_URL_FLORA = "FloraFauna.json";
  const QUESTIONS_URL_FILM  = "FilmGlazba.json";
  const QUESTIONS_URL_ANTICKI_RIM = "AntickiRim.json";
  const QUESTIONS_URL_AMERICKIPREDSJEDNICI = "AmerickiPredsjednici.json";
 
  let ALL_QUESTIONS = [];
  let loadedBlitzCount = 0;
  let loadedStoryCount = 0;
  let loadedFloraCount = 0;
  let loadedFilmCount  = 0;
  let loadedAntickiRimCount = 0;
  let loadedAmerickiPredsjedniciCount = 0;
  
  // mode: "blitz60" | "story90" | "relax" | "themed"
  let currentMode = "blitz60";
  let currentThemeTopic = null; // npr "AntickiRim"
  let currentQuestion = null;

  // zadržavamo postojeći set (nije nužno za queue, ali ostaje kompatibilno)
  let usedQuestionIds = new Set();

  // za miksanje težina (ostaje kao prije)
  let lastDifficulty = null;
  let sameDifficultyStreak = 0;

  // ✅ Topic cooldown za normalne modove (u tematskom se ne koristi)
  const TOPIC_COOLDOWN = 5;
  let recentTopics = [];

  // ✅ "špil" pitanja po modu
  let questionQueue = [];
  let queueMode = null;
  let queueTheme = null;

  let timerDurationMs = 60000;
  let remainingMs = 60000;
  let timerIntervalId = null;
  let timerRunning = false;
  let timerPausedForTyping = false;
  let typingPauseUntil = 0;
  let typingPauseUsedForCurrentQuestion = false;

  let scoreCorrect = 0;
  let scoreWrong = 0;
  let scoreTotal = 0;

  let quizFinished = false;

  /* ------------------ INIT ------------------ */

  document.addEventListener("DOMContentLoaded", async () => {
    initYear();
    initModeSwitch();
    initThemedUI();
    initButtons();
    await loadQuestionsFromJson();
    updateModeLabel();
    updateScoreUI();
    setQuizInteractionEnabled(true);
    updateTimerUI(); // da odmah pokaže ∞ ako treba
  });

  function initYear() {
    const y = document.getElementById("year");
    if (y) y.textContent = new Date().getFullYear();
  }

  /* ------------------ LOAD QUESTIONS (JSON) ------------------ */

  async function loadQuestionsFromJson() {
    try {
      const [respBlitz, respStory, respFlora, respFilm, respAntickiRim, respAmerickiPredsjednici] = await Promise.all([
        fetch(QUESTIONS_URL_BLITZ),
        fetch(QUESTIONS_URL_STORY),
        fetch(QUESTIONS_URL_FLORA),
        fetch(QUESTIONS_URL_FILM),
        fetch(QUESTIONS_URL_ANTICKI_RIM),
        fetch(QUESTIONS_URL_AMERICKI_PREDSJEDNICI)
      ]);

      if (!respBlitz.ok || !respStory.ok || !respFlora.ok || !respFilm.ok || !respAntickiRim.ok || !respAmerickiPredsjednici.ok) {
        throw new Error("Greška pri čitanju JSON datoteka.");
      }

      const blitzData = await respBlitz.json();
      const storyData = await respStory.json();
      const floraData = await respFlora.json();
      const filmData  = await respFilm.json();
      const antickiRimData = await respAntickiRim.json();
      const americkiPredsjedniciData = await respAmerickiPredsjednici.json();
      
      if (!Array.isArray(blitzData) || !Array.isArray(storyData) || !Array.isArray(floraData) || !Array.isArray(filmData) || !Array.isArray(antickiRimData) || !Array.isArray(americkiPredsjedniciData)) {
        throw new Error("JSON format nije ispravan (očekuje se lista).");
      }

      const normalizedBlitz = blitzData.map((q, idx) => ({
        id: q.id ?? "blitz-" + idx,
        type: q.type || "blitz",
        difficulty: typeof q.difficulty === "number" ? q.difficulty : 1,
        topic: (q.topic && String(q.topic).trim()) ? String(q.topic).trim() : "Ostalo",
        question: q.question || "",
        answers: Array.isArray(q.answers) ? q.answers : [],
        image: q.image || null
      }));

      const normalizedStory = storyData.map((q, idx) => ({
        id: q.id ?? "story-" + idx,
        type: q.type || "story",
        difficulty: typeof q.difficulty === "number" ? q.difficulty : 1,
        topic: (q.topic && String(q.topic).trim()) ? String(q.topic).trim() : "Ostalo",
        question: q.question || "",
        answers: Array.isArray(q.answers) ? q.answers : [],
        image: q.image || null
      }));

      const normalizedFlora = floraData.map((q, idx) => ({
        id: q.id ?? "flora-" + idx,
        type: q.type || "blitz", // default: ubaci u Blitz + Relax
        difficulty: typeof q.difficulty === "number" ? q.difficulty : 1,
        topic: (q.topic && String(q.topic).trim()) ? String(q.topic).trim() : "FloraFauna",
        question: q.question || "",
        answers: Array.isArray(q.answers) ? q.answers : [],
        image: q.image || null
      }));

      const normalizedFilm = filmData.map((q, idx) => ({
        id: q.id ?? "film-" + idx,
        type: q.type || "blitz",
        difficulty: typeof q.difficulty === "number" ? q.difficulty : 1,
        topic: (q.topic && String(q.topic).trim()) ? String(q.topic).trim() : "FilmGlazba",
        question: q.question || "",
        answers: Array.isArray(q.answers) ? q.answers : [],
        image: q.image || null
      }));

      const normalizedAntickiRim = antickiRimData.map((q, idx) => ({
        id: q.id ?? "antickiRim-" + idx,
        type: q.type || "blitz", // da ulazi u Blitz + Relax (a možeš i "story" ako imaš duža)
        difficulty: typeof q.difficulty === "number" ? q.difficulty : 1,
        topic: "AntickiRim",
        question: q.question || "",
        answers: Array.isArray(q.answers) ? q.answers : [],
        image: q.image || null
      }));

      const normalizedAmerickiPredsjednici = americkiPredsjedniciData.map((q, idx) => ({
        id: q.id ?? "americkiPredsjednici-" + idx,
        type: q.type || "blitz", // da ulazi u Blitz + Relax (a možeš i "story" ako imaš duža)
        difficulty: typeof q.difficulty === "number" ? q.difficulty : 1,
        topic: "AmerickiPredsjednici",
        question: q.question || "",
        answers: Array.isArray(q.answers) ? q.answers : [],
        image: q.image || null
      }));

      ALL_QUESTIONS = [...normalizedBlitz, ...normalizedStory, ...normalizedFlora, ...normalizedFilm, ...normalizedAntickiRim, ...normalizedAmerickiPredsjednici];
      loadedBlitzCount = normalizedBlitz.length;
      loadedStoryCount = normalizedStory.length;
      loadedFloraCount = normalizedFlora.length;
      loadedFilmCount  = normalizedFilm.length;
      loadedAntickiRimCount = normalizedAntickiRim.length;
      loadedAmerickiPredsjedniciCount = normalizedAmerickiPredsjednici.length;
      
      resetQuestionQueue();
    } catch (err) {
      console.error("Greška pri učitavanju pitanja:", err);
    }
  }

  /* ------------------ MODE SWITCH (PILLS) ------------------ */

  function initModeSwitch() {
    const pills = document.querySelectorAll(".mode-pill");
    pills.forEach((pill) => {
      pill.addEventListener("click", () => {
        const mode = pill.getAttribute("data-mode");
        if (!mode || mode === currentMode) return;

        // Ako user klikne običan mod, izlazimo iz tematskog
        currentMode = mode;
        currentThemeTopic = null;
        syncThemedActiveUI(null);

        pills.forEach((p) => p.classList.toggle("active", p === pill));

        stopTimer();
        resetTimerForMode();

        usedQuestionIds.clear();
        resetQuestionQueue();

        typingPauseUsedForCurrentQuestion = false;
        quizFinished = false;

        lastDifficulty = null;
        sameDifficultyStreak = 0;

        recentTopics = [];

        setQuizInteractionEnabled(true);
        updateModeLabel();
        updateTimerUI();
      });
    });
  }

  function resetTimerForMode() {
    if (currentMode === "blitz60") timerDurationMs = 60000;
    else if (currentMode === "story90") timerDurationMs = 90000;
    else timerDurationMs = 0; // relax + themed = bez vremena

    remainingMs = timerDurationMs;
    updateTimerUI();
  }

  function isTimedMode() {
    return currentMode === "blitz60" || currentMode === "story90";
  }

  function updateModeLabel() {
    const subtitleEl = document.getElementById("quiz-mode-label");
    const titleEl = document.getElementById("quiz-title");
    if (!subtitleEl || !titleEl) return;

    if (currentMode === "blitz60") {
      titleEl.textContent = "Blitz kviz";
      subtitleEl.textContent = "Brza pitanja u 60 sekundi";
    } else if (currentMode === "story90") {
      titleEl.textContent = "Story kviz";
      subtitleEl.textContent = "Duže priče i pitanja u 90 sekundi";
    } else if (currentMode === "themed") {
      titleEl.textContent = "Tematski kviz";
      subtitleEl.textContent = currentThemeTopic ? ("Tema: " + prettyThemeName(currentThemeTopic)) : "Odaberi temu";
    } else {
      titleEl.textContent = "Bezvremenski kviz";
      subtitleEl.textContent = "Opušteni mix blitz + story bez ograničenja";
    }
  }

  /* ------------------ TEMATSKI UI ------------------ */

  function initThemedUI() {
    const btn = document.getElementById("btn-themed");
    const panel = document.getElementById("themed-panel");
    const themedButtons = document.querySelectorAll(".themed-topic");

    if (btn && panel) {
      btn.addEventListener("click", () => {
        const open = panel.classList.toggle("open");
        btn.classList.toggle("active", open);
      });
    }

    themedButtons.forEach(b => {
      b.addEventListener("click", () => {
        const topic = b.getAttribute("data-topic");
        if (!topic) return;

        // Prebaci na themed mod
        currentMode = "themed";
        currentThemeTopic = topic;

        // makni active s mode pillova (da se jasno vidi da je themed poseban)
        document.querySelectorAll(".mode-pill").forEach(p => p.classList.remove("active"));

        // označi aktivnu temu
        themedButtons.forEach(x => x.classList.toggle("active", x === b));
        syncThemedActiveUI(topic);

        stopTimer();
        resetTimerForMode();

        usedQuestionIds.clear();
        resetQuestionQueue();

        typingPauseUsedForCurrentQuestion = false;
        quizFinished = false;

        lastDifficulty = null;
        sameDifficultyStreak = 0;

        recentTopics = [];

        setQuizInteractionEnabled(true);
        updateModeLabel();
        updateTimerUI();
      });
    });
  }

  function prettyThemeName(topicKey) {
    const map = {
      "HarryPotter": "Harry Potter",
      "LOTR": "L.O.T.R.",
      "PiratiSKariba": "Pirati s Kariba",
      "VolimHrvatsku": "Volim Hrvatsku",
      "VolimBiH": "Volim BiH",
      "VolimSrbiju": "Volim Srbiju",
      "AntickaGrcka": "Antička Grčka",
      "AntickiEgipat": "Antički Egipat",
      "AntickiRim": "Antički Rim",
      "AmerickiPredsjednici": "Američki predsjednici"
    };
    return map[topicKey] || topicKey;
  }

  function syncThemedActiveUI(topicOrNull) {
    const badge = document.getElementById("themed-active-badge");
    const name = document.getElementById("themed-active-name");
    if (!badge || !name) return;

    if (!topicOrNull) {
      badge.style.display = "none";
      name.textContent = "";
      // makni active na temama
      document.querySelectorAll(".themed-topic").forEach(x => x.classList.remove("active"));
      return;
    }

    badge.style.display = "inline-flex";
    name.textContent = prettyThemeName(topicOrNull);
  }

  /* ------------------ BUTTONS ------------------ */

  function initButtons() {
    const btnStart = document.getElementById("btn-start");
    const btnSubmit = document.getElementById("btn-submit-answer");
    const btnSkip = document.getElementById("btn-skip");
    const btnReset = document.getElementById("btn-reset");
    const answerInput = document.getElementById("answer-input");

    if (btnStart) {
      btnStart.addEventListener("click", () => startNewRound(isTimedMode()));
    }

    if (btnSubmit && answerInput) {
      btnSubmit.addEventListener("click", () => handleSubmitAnswer());

      answerInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          handleSubmitAnswer();
          return;
        }

        if (!typingPauseUsedForCurrentQuestion && isTimedMode() && !quizFinished) {
          typingPauseUsedForCurrentQuestion = true;
          pauseTimerForTyping();
        }
      });

      answerInput.addEventListener("focus", () => {
        const card = document.getElementById("quiz-card");
        if (card) card.scrollIntoView({ block: "center", behavior: "smooth" });
      });
    }

    if (btnSkip) {
      btnSkip.addEventListener("click", () => {
        if (isTimedMode() && quizFinished) return;
        if (!currentQuestion) return;

        scoreTotal++;
        scoreWrong++;
        updateScoreUI();

        logAnswerHistory("", { ok:false, exact:false }, true);
        loadNextQuestion();
      });
    }

    if (btnReset) {
      btnReset.addEventListener("click", () => resetQuiz());
    }
  }

  function setQuizInteractionEnabled(enabled) {
    const answerInput = document.getElementById("answer-input");
    const btnSubmit = document.getElementById("btn-submit-answer");
    const btnSkip = document.getElementById("btn-skip");
    if (answerInput) answerInput.disabled = !enabled;
    if (btnSubmit) btnSubmit.disabled = !enabled;
    if (btnSkip) btnSkip.disabled = !enabled;
  }

  /* ------------------ ROUND MANAGEMENT ------------------ */

  function startNewRound(startTimerAlso) {
    usedQuestionIds.clear();
    resetQuestionQueue();

    scoreCorrect = 0;
    scoreWrong = 0;
    scoreTotal = 0;
    quizFinished = false;

    lastDifficulty = null;
    sameDifficultyStreak = 0;

    recentTopics = [];

    updateScoreUI();
    clearHistoryList();
    stopTimer();
    resetTimerForMode();
    typingPauseUsedForCurrentQuestion = false;
    setQuizInteractionEnabled(true);

    loadNextQuestion();

    if (startTimerAlso && isTimedMode()) startTimer();
    else stopTimer();
  }

  /* ------------------ STRONGER RANDOM (SHUFFLED QUEUE) ------------------ */

  function resetQuestionQueue() {
    questionQueue = [];
    queueMode = null;
    queueTheme = null;
  }

  function shuffleArray(arr) {
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function ensureQueueReady() {
    // za themed: promjena teme mora rebuildati queue
    const themeKey = currentMode === "themed" ? currentThemeTopic : null;

    if (queueMode !== currentMode || queueTheme !== themeKey || questionQueue.length === 0) {
      const pool = getQuestionPoolForCurrentMode();
      if (!pool.length) {
        questionQueue = [];
        queueMode = currentMode;
        queueTheme = themeKey;
        return;
      }

      questionQueue = shuffleArray(pool);

      if (questionQueue.length >= 12 && Math.random() < 0.35) {
        const cut = Math.floor(questionQueue.length * (0.25 + Math.random() * 0.5));
        questionQueue = questionQueue.slice(cut).concat(questionQueue.slice(0, cut));
      }

      queueMode = currentMode;
      queueTheme = themeKey;

      usedQuestionIds.clear();
      lastDifficulty = null;
      sameDifficultyStreak = 0;
      recentTopics = [];
    }
  }

  function getTopicSafe(q) {
    const t = (q && q.topic && String(q.topic).trim()) ? String(q.topic).trim() : "Ostalo";
    return t;
  }

  // ✅ topic cooldown pick (NE koristi se u tematskom modu)
  function pickFromQueueRespectTopicCooldown() {
    if (questionQueue.length === 0) return null;

    // u tematskom modu je ionako sve isti topic -> samo pop
    if (currentMode === "themed") return questionQueue.pop();

    const peek = questionQueue[questionQueue.length - 1];
    const peekTopic = getTopicSafe(peek);

    if (!recentTopics.includes(peekTopic)) return questionQueue.pop();

    const scan = Math.min(18, questionQueue.length);
    for (let i = 1; i <= scan; i++) {
      const idx = questionQueue.length - i;
      const q = questionQueue[idx];
      if (!q) continue;

      const t = getTopicSafe(q);
      if (!recentTopics.includes(t)) {
        questionQueue.splice(idx, 1);
        return q;
      }
    }

    return questionQueue.pop();
  }

  function loadNextQuestion() {
    if (isTimedMode() && quizFinished) return;

    ensureQueueReady();
    if (!questionQueue.length) return;

    const chosen = pickFromQueueRespectTopicCooldown();
    if (!chosen) return;

    currentQuestion = chosen;
    usedQuestionIds.add(chosen.id);

    if (typeof chosen.difficulty === "number") {
      if (lastDifficulty === chosen.difficulty) sameDifficultyStreak++;
      else { lastDifficulty = chosen.difficulty; sameDifficultyStreak = 1; }
    } else {
      lastDifficulty = null;
      sameDifficultyStreak = 0;
    }

    // topic cooldown history samo u non-themed
    if (currentMode !== "themed") {
      const chosenTopic = getTopicSafe(chosen);
      recentTopics.push(chosenTopic);
      if (recentTopics.length > TOPIC_COOLDOWN) recentTopics.shift();
    }

    typingPauseUsedForCurrentQuestion = false;
    timerPausedForTyping = false;
    typingPauseUntil = 0;

    updateQuestionUI(chosen);
    clearAnswerField();
  }

  function getQuestionPoolForCurrentMode() {
    // Osnovno: validna pitanja
    let base = ALL_QUESTIONS.filter(q => {
      if (!q || !q.question || !Array.isArray(q.answers) || q.answers.length === 0) return false;
      return true;
    });

    // Mod filter
    if (currentMode === "blitz60") base = base.filter(q => q.type === "blitz");
    else if (currentMode === "story90") base = base.filter(q => q.type === "story");
    else base = base.filter(q => q.type === "blitz" || q.type === "story"); // relax + themed

    // ✅ Tematski filter: samo odabrani topic
    if (currentMode === "themed" && currentThemeTopic) {
      base = base.filter(q => String(q.topic).trim() === String(currentThemeTopic).trim());
    }

    return base;
  }

  /* ------------------ UI UPDATE – QUESTION ------------------ */

  function updateQuestionUI(q) {
    const questionTextEl = document.getElementById("question-text");
    const typeLabelEl = document.getElementById("question-type-label");
    const diffPillEl = document.getElementById("question-difficulty-pill");
    const imgEl = document.getElementById("question-image");
    const feedbackEl = document.getElementById("answer-feedback");

    if (questionTextEl) questionTextEl.textContent = q.question || "(prazno pitanje)";
    if (typeLabelEl) typeLabelEl.textContent = (q.type === "blitz" ? "Tip: Blitz" : "Tip: Story");

    if (diffPillEl) {
      const d = typeof q.difficulty === "number" ? q.difficulty : "—";
      diffPillEl.textContent = "Težina " + d + "/5";
    }

    if (imgEl) {
      if (q.image) {
        imgEl.src = q.image;
        imgEl.alt = "Vizualna pomoć za pitanje";
        imgEl.style.display = "block";
      } else {
        imgEl.src = "";
        imgEl.alt = "";
        imgEl.style.display = "none";
      }
    }

    if (feedbackEl) {
      feedbackEl.textContent = "";
      feedbackEl.classList.remove("correct", "incorrect");
    }
  }

  function clearAnswerField() {
    const input = document.getElementById("answer-input");
    if (input) { input.value = ""; input.focus(); }
  }

  /* ------------------ TIMER ------------------ */

  function startTimer() {
    if (!isTimedMode()) return;

    stopTimer();
    timerRunning = true;
    timerPausedForTyping = false;
    typingPauseUntil = 0;
    quizFinished = false;

    let lastTime = performance.now();

    timerIntervalId = requestAnimationFrame(function tick(now) {
      if (!timerRunning) return;

      if (timerPausedForTyping) {
        if (now >= typingPauseUntil) timerPausedForTyping = false;
        else { updateTimerUI(); timerIntervalId = requestAnimationFrame(tick); return; }
      }

      const delta = now - lastTime;
      lastTime = now;

      remainingMs -= delta;
      if (remainingMs <= 0) {
        remainingMs = 0;
        updateTimerUI();
        timerRunning = false;
        quizFinished = true;
        currentQuestion = null;
        setQuizInteractionEnabled(false);
        return;
      }

      updateTimerUI();
      timerIntervalId = requestAnimationFrame(tick);
    });
  }

  function stopTimer() {
    timerRunning = false;
    if (timerIntervalId) { cancelAnimationFrame(timerIntervalId); timerIntervalId = null; }
  }

  function pauseTimerForTyping() {
    if (!isTimedMode() || !timerRunning) return;
    timerPausedForTyping = true;
    typingPauseUntil = performance.now() + 2000;
  }

  function forceResumeTimerFromTyping() {
    if (!isTimedMode()) return;
    if (timerPausedForTyping) { timerPausedForTyping = false; typingPauseUntil = 0; }
  }

  function updateTimerUI() {
    const valEl = document.getElementById("timer-value");
    const pill = document.getElementById("timer-pill");
    if (!valEl || !pill) return;

    if (!isTimedMode()) {
      pill.style.opacity = 0.35;
      valEl.textContent = "∞";
      return;
    }

    pill.style.opacity = 1;
    valEl.textContent = (remainingMs / 1000).toFixed(1);
  }

  /* ------------------ ANSWERS ------------------ */
  // ✅ Ovo je "ovako kako smo dogovorili":
  // - di caprio == DiCaprio (razmaci se ignoriraju u jednom od checkova)
  // - prihvaća prezime kad je u bazi ime+prezime
  // - prihvaća male tipfelere (Onsk ~ Omsk) po Levenshteinu
  // - ako NIJE 100% isto -> u povijesti piše "Prihvaćeno (≈)" i odmah ispod "100% točno: <answers[0]>"

  function normalizeWords(s) {
    return (s || "")
      .toString()
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")     // dijakritika
      .replace(/[^a-z0-9\s]/g, " ")        // interpunkcija -> razmak
      .replace(/\s+/g, " ")
      .trim();
  }

  function normalizeCollapsed(s) {
    // kao normalizeWords, ali bez razmaka (Di Caprio == DiCaprio)
    return normalizeWords(s).replace(/\s+/g, "");
  }

  function escapeRegex(s) {
    return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
  }

  function levenshtein(a, b) {
    const s = a || "";
    const t = b || "";
    const n = s.length;
    const m = t.length;
    if (n === 0) return m;
    if (m === 0) return n;

    const dp = Array.from({ length: n + 1 }, () => new Array(m + 1).fill(0));
    for (let i = 0; i <= n; i++) dp[i][0] = i;
    for (let j = 0; j <= m; j++) dp[0][j] = j;

    for (let i = 1; i <= n; i++) {
      for (let j = 1; j <= m; j++) {
        const cost = s[i - 1] === t[j - 1] ? 0 : 1;
        dp[i][j] = Math.min(
          dp[i - 1][j] + 1,
          dp[i][j - 1] + 1,
          dp[i - 1][j - 1] + cost
        );
      }
    }
    return dp[n][m];
  }

  function allowedTyposByLength(len) {
    if (len <= 4) return 0;
    if (len <= 7) return 1;
    if (len <= 11) return 2;
    return 3;
  }

  function containsWholeWordOrPhrase(haystackRaw, needleRaw) {
    const hay = normalizeWords(haystackRaw);
    const needle = normalizeWords(needleRaw);
    if (!hay || !needle) return false;

    const re = new RegExp(`(^|\\s)${escapeRegex(needle)}(\\s|$)`, "i");
    return re.test(hay);
  }

  function lastToken(s) {
    const w = normalizeWords(s);
    if (!w) return "";
    const parts = w.split(" ").filter(Boolean);
    return parts[parts.length - 1] || "";
  }

  function checkAnswerDetailed(question, userAnswerRaw) {
    const answers = Array.isArray(question.answers) ? question.answers : [];
    const userW = normalizeWords(userAnswerRaw);
    const userC = normalizeCollapsed(userAnswerRaw);
    if (!answers.length || !userW) {
      return { ok: false, exact: false, matched: null, reason: "" };
    }

    let best = { ok: false, exact: false, matched: null, reason: "", dist: Infinity };

    for (const saved of answers) {
      if (!saved) continue;

      const savedW = normalizeWords(saved);
      const savedC = normalizeCollapsed(saved);
      if (!savedW) continue;

      // 1) EXACT (nakon normalizacije)
      if (userW === savedW || userC === savedC) {
        return { ok: true, exact: true, matched: saved, reason: "exact" };
      }

      // 2) user sadrži spremljeni odgovor kao riječ/frazu (tvoj koncept)
      if (containsWholeWordOrPhrase(userAnswerRaw, saved)) {
        best = { ok: true, exact: false, matched: saved, reason: "contains", dist: 0 };
        continue;
      }

      // 3) prezime-only
      const savedLast = lastToken(saved);
      if (savedW.includes(" ") && userW === savedLast && userW.length >= 3) {
        best = { ok: true, exact: false, matched: saved, reason: "surname", dist: 0 };
        continue;
      }
      if (savedW.includes(" ") && savedLast && containsWholeWordOrPhrase(userAnswerRaw, savedLast)) {
        best = { ok: true, exact: false, matched: saved, reason: "surname-in-phrase", dist: 0 };
        continue;
      }

      // 4) tipfeleri (Onsk ~ Omsk)
      const len = Math.max(savedC.length, userC.length);
      const allowed = allowedTyposByLength(len);

      if (allowed > 0) {
        const d = levenshtein(userC, savedC);
        if (d <= allowed && len >= 5) {
          if (!best.ok || d < best.dist) {
            best = { ok: true, exact: false, matched: saved, reason: "typo", dist: d };
          }
        }
      }
    }

    if (best.ok) return best;
    return { ok: false, exact: false, matched: null, reason: "" };
  }

  function handleSubmitAnswer() {
    if (isTimedMode() && quizFinished) return;
    if (!currentQuestion) return;

    const input = document.getElementById("answer-input");
    const feedbackEl = document.getElementById("answer-feedback");
    if (!input || !feedbackEl) return;

    const userAnswerRaw = input.value.trim();
    if (!userAnswerRaw) return;

    forceResumeTimerFromTyping();

    const res = checkAnswerDetailed(currentQuestion, userAnswerRaw);

    scoreTotal++;
    if (res.ok) scoreCorrect++;
    else scoreWrong++;

    updateScoreUI();
    logAnswerHistory(userAnswerRaw, res, false);

    if (res.ok) {
      feedbackEl.textContent = res.exact ? "Točno! ✅" : "Prihvaćeno (≈) ✅";
      feedbackEl.classList.toggle("correct", true);
      feedbackEl.classList.toggle("incorrect", false);
    } else {
      feedbackEl.textContent = "Netočno. ❌";
      feedbackEl.classList.toggle("correct", false);
      feedbackEl.classList.toggle("incorrect", true);
    }

    setTimeout(() => {
      if (isTimedMode() && quizFinished) return;
      loadNextQuestion();
    }, 600);
  }

  /* ------------------ SCORE & HISTORY UI ------------------ */

  function updateScoreUI() {
    const c = document.getElementById("score-correct");
    const t = document.getElementById("score-total");
    const cSmall = document.getElementById("score-correct-small");
    const wSmall = document.getElementById("score-wrong-small");
    const percentEl = document.getElementById("score-percent");

    if (c) c.textContent = scoreCorrect;
    if (t) t.textContent = scoreTotal;
    if (cSmall) cSmall.textContent = scoreCorrect;
    if (wSmall) wSmall.textContent = scoreWrong;

    let percent = 0;
    if (scoreTotal > 0) percent = Math.round((scoreCorrect / scoreTotal) * 100);
    if (percentEl) percentEl.textContent = percent + "% uspješnosti";
  }

  function logAnswerHistory(userAnswer, resultOrBool, skipped) {
    const list = document.getElementById("history-list");
    if (!list || !currentQuestion) return;

    const res = (typeof resultOrBool === "object" && resultOrBool)
      ? resultOrBool
      : { ok: !!resultOrBool, exact: !!resultOrBool, matched: null, reason: "" };

    const li = document.createElement("li");
    li.className = "history-item " + (skipped ? "incorrect" : (res.ok ? "correct" : "incorrect"));

    const qDiv = document.createElement("div");
    qDiv.className = "history-q";
    qDiv.textContent = currentQuestion.question || "(pitanje)";

    const metaDiv = document.createElement("div");
    metaDiv.className = "history-meta";

    const typeLabel = currentQuestion.type === "blitz" ? "Blitz" : "Story";
    const diffText = "Težina " + (currentQuestion.difficulty ?? "—") + "/5";
    metaDiv.innerHTML = `<span>${typeLabel}</span><span>${diffText}</span>`;

    const aDiv = document.createElement("div");
    aDiv.className = "history-a";

    const answers = currentQuestion.answers || [];
    const mainAnswer = answers[0] || "(nema odgovora)";

    if (skipped) {
      aDiv.innerHTML = `<span class="label">Preskočeno.</span> Točan odgovor: <strong>${mainAnswer}</strong>`;
    } else if (res.ok) {
      const verdict = res.exact ? "Točno ✔" : "Prihvaćeno (≈) ✔";

      aDiv.innerHTML =
        `<span class="label">Tvoj odgovor:</span> ${userAnswer || "(prazno)"}<br>` +
        `<span class="label">${verdict}</span>`;

      // ✅ Ključno: ako nije 100% isto, prikaži odmah ispod 100% odgovor
      if (!res.exact) {
        aDiv.innerHTML += `<br><span class="label">100% točno:</span> <strong>${mainAnswer}</strong>`;
      }
    } else {
      aDiv.innerHTML =
        `<span class="label">Tvoj odgovor:</span> ${userAnswer || "(prazno)"}<br>` +
        `<span class="label">Točan odgovor:</span> <strong>${mainAnswer}</strong>`;
    }

    li.appendChild(qDiv);
    li.appendChild(metaDiv);
    li.appendChild(aDiv);

    list.prepend(li);
  }

  function clearHistoryList() {
    const list = document.getElementById("history-list");
    if (list) list.innerHTML = "";
  }

  /* ------------------ RESET ------------------ */

  function resetQuiz() {
    stopTimer();
    resetTimerForMode();

    currentQuestion = null;
    usedQuestionIds.clear();
    resetQuestionQueue();

    typingPauseUsedForCurrentQuestion = false;

    lastDifficulty = null;
    sameDifficultyStreak = 0;

    recentTopics = [];

    scoreCorrect = 0;
    scoreWrong = 0;
    scoreTotal = 0;
    quizFinished = false;

    updateScoreUI();
    clearHistoryList();
    setQuizInteractionEnabled(true);

    const questionTextEl = document.getElementById("question-text");
    const typeLabelEl = document.getElementById("question-type-label");
    const diffPillEl = document.getElementById("question-difficulty-pill");
    const imgEl = document.getElementById("question-image");
    const feedbackEl = document.getElementById("answer-feedback");
    const input = document.getElementById("answer-input");

    if (questionTextEl) {
      questionTextEl.innerHTML = 'Kviz je resetiran. Odaberi mod i klikni <strong>“Kreni s kvizom”</strong>.';
    }
    if (typeLabelEl) typeLabelEl.textContent = "Tip: —";
    if (diffPillEl) diffPillEl.textContent = "Težina —/5";
    if (imgEl) { imgEl.src = ""; imgEl.style.display = "none"; }
    if (feedbackEl) { feedbackEl.textContent = ""; feedbackEl.classList.remove("correct", "incorrect"); }
    if (input) input.value = "";
  }
</script>
</body>
</html>
