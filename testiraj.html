<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8">
  <title>Testiraj svoje znanje | Balkan Pub Quiz Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- SEO osnovno -->
  <meta name="description" content="Testiraj svoje znanje blitz i story pub kviz pitanjima. Biraj mod, uključi štopericu i igraj sam ili s ekipom.">
  <link rel="canonical" href="https://zvonebeslic.github.io/testiraj.html">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Testiraj svoje znanje – Balkan Pub Quiz Map">
  <meta property="og:description" content="Blitz i story pub kviz pitanja s Balkana – 60 i 90 sekundi, ili bez vremena.">
  <meta property="og:url" content="https://zvonebeslic.github.io/testiraj.html">
  <meta property="og:image" content="https://images.pexels.com/photos/301692/pexels-photo-301692.jpeg?auto=compress&cs=tinysrgb&w=1200">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Testiraj svoje znanje – Balkan Pub Quiz Map">
  <meta name="twitter:description" content="Probaj blitz kviz u 60 sekundi ili story kviz u 90 sekundi.">
  <meta name="twitter:image" content="https://images.pexels.com/photos/301692/pexels-photo-301692.jpeg?auto=compress&cs=tinysrgb&w=1200">

  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg-main: #120b07;
      --bg-wood: #3b2414;
      --bg-card: rgba(20, 10, 5, 0.94);
      --accent: #f5c15b;
      --accent-soft: #c07a2b;
      --accent-red: #ff6b6b;
      --accent-green: #7fd95b;
      --accent-blue: #5fb6ff;
      --text-main: #f9efe0;
      --text-muted: #c7b7a3;
      --border-soft: rgba(250, 245, 230, 0.18);
      /* jača sjena da prozori fino iskoče */
      --shadow-soft: 0 25px 60px rgba(0, 0, 0, 0.9);
    }

    html, body {
      height: 100%;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top left, rgba(255, 250, 220, 0.08), transparent 60%),
        radial-gradient(circle at bottom right, rgba(255, 200, 150, 0.08), transparent 60%),
        url("https://images.pexels.com/photos/301692/pexels-photo-301692.jpeg?auto=compress&cs=tinysrgb&w=1600") center/cover fixed,
        var(--bg-main);
      color: var(--text-main);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* HEADER */

    .site-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.9rem 1.2rem;
      background: linear-gradient(135deg, #1d1209, #381f12);
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
    }

    .logo-wrap {
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .logo-icon {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #ffe8a3, #e59f33);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow:
        0 0 12px rgba(245, 193, 91, 0.7),
        0 0 30px rgba(245, 193, 91, 0.2);
      overflow: hidden;
    }

    .logo-icon img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: inherit;
    }

    .logo-text {
      display: flex;
      flex-direction: column;
      line-height: 1.1;
    }

    .logo-main {
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      font-size: 1rem;
    }

    .logo-sub {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .top-nav {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: flex-end;
      align-items: center;
    }

    .nav-btn {
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: transparent;
      color: var(--text-main);
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      transition: background 0.15s ease, transform 0.1s ease, border-color 0.15s ease;
      text-decoration: none;
    }

    .nav-btn--primary {
      background: radial-gradient(circle at 30% 20%, #ffe8a3, var(--accent-soft));
      color: #2b1608;
      border-color: rgba(255, 220, 160, 0.7);
      font-weight: 600;
    }

    .nav-btn:hover {
      transform: translateY(-1px);
      background: rgba(255, 255, 255, 0.04);
    }

    .nav-btn--primary:hover {
      background: radial-gradient(circle at 30% 20%, #fff0c4, #e19122);
    }

    /* MAIN LAYOUT */

    .page-wrap {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
      padding: 1.2rem;
      gap: 1rem;
    }

    .quiz-hero {
      background: radial-gradient(circle at top, rgba(255, 240, 210, 0.1), rgba(0, 0, 0, 0.96));
      border-radius: 20px;
      padding: 1rem 1.2rem;
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      display: grid;
      grid-template-columns: 1.6fr 1.2fr;
      gap: 1rem;
      align-items: center;
      backdrop-filter: blur(12px);
    }

    .quiz-hero-main-title {
      font-size: 1.4rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      margin-bottom: 0.35rem;
    }

    .quiz-hero-subtitle {
      font-size: 0.95rem;
      color: var(--text-muted);
      margin-bottom: 0.6rem;
    }

    .quiz-hero-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-bottom: 0.6rem;
    }

    .badge {
      font-size: 0.75rem;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(0, 0, 0, 0.5);
      color: var(--text-muted);
    }

    .badge--accent {
      background: rgba(245, 193, 91, 0.12);
      border-color: rgba(245, 193, 91, 0.8);
      color: var(--accent);
      font-weight: 500;
    }

    .mode-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-bottom: 0.4rem;
    }

    .mode-pill {
      border-radius: 999px;
      padding: 0.4rem 0.8rem;
      font-size: 0.8rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(0, 0, 0, 0.5);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      color: var(--text-main);
      transition: background 0.15s ease, transform 0.1s ease, border-color 0.15s ease;
    }

    .mode-pill span.mode-label {
      font-weight: 600;
    }

    .mode-pill span.mode-desc {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .mode-pill.active {
      background: radial-gradient(circle at 20% 0, #ffe8a3, var(--accent-soft));
      color: #2b1608;
      border-color: rgba(255, 222, 180, 0.9);
      transform: translateY(-1px);
      box-shadow: 0 0 10px rgba(245, 193, 91, 0.7);
    }

    .mode-pill.active span.mode-desc {
      color: #3e2410;
    }

    .hero-right-card {
      background: rgba(0, 0, 0, 0.8);
      border-radius: 18px;
      border: 1px solid var(--border-soft);
      padding: 0.8rem;
      font-size: 0.82rem;
      color: var(--text-muted);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(10px);
    }

    .hero-right-card h3 {
      font-size: 0.9rem;
      margin-bottom: 0.4rem;
      color: var(--text-main);
    }

    .hero-right-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .hero-right-list li::before {
      content: "• ";
      color: var(--accent);
    }

    /* MAIN GRID: kviz + sidebar */

    .quiz-main-grid {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(260px, 1.2fr);
      gap: 1rem;
      align-items: flex-start;
    }

    .quiz-card {
      background: var(--bg-card);
      border-radius: 18px;
      padding: 0.9rem 0.9rem 0.9rem;
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(14px);
      min-height: 320px;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .quiz-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
    }

    .quiz-card-title-block {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .quiz-card-title {
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .quiz-card-subtitle {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .timer-pill {
      min-width: 90px;
      text-align: right;
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.95rem;
      padding: 0.35rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      background: rgba(0, 0, 0, 0.6);
      display: inline-flex;
      justify-content: flex-end;
      gap: 0.35rem;
      align-items: center;
    }

    .timer-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .timer-value {
      font-weight: 600;
    }

    .question-image {
      width: 100%;
      max-height: 210px;
      border-radius: 14px;
      object-fit: cover;
      margin-top: 0.4rem;
      border: 1px solid rgba(255, 255, 255, 0.12);
    }

    .question-text-wrap {
      margin-top: 0.4rem;
    }

    .question-text-label {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-bottom: 0.15rem;
    }

    .question-text {
      font-size: 0.95rem;
      line-height: 1.4;
    }

    .question-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .question-meta span {
      margin-right: 0.4rem;
    }

    .question-meta .difficulty-pill {
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      font-size: 0.7rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      padding: 0.45rem 1.1rem;
      font-size: 0.85rem;
      cursor: pointer;
      background: rgba(0, 0, 0, 0.4);
      color: var(--text-main);
      transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease, opacity 0.12s ease;
      text-decoration: none;
    }

    .btn:disabled {
      opacity: 0.45;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .btn--accent {
      background: radial-gradient(circle at 20% 0, #ffe8a3, var(--accent-soft));
      border-color: rgba(255, 222, 180, 0.9);
      color: #2b1608;
      font-weight: 600;
      box-shadow: 0 0 12px rgba(245, 193, 91, 0.6);
    }

    .btn--accent:hover:not(:disabled) {
      background: radial-gradient(circle at 20% 0, #fff2c6, #e18b1d);
      transform: translateY(-1px);
      box-shadow: 0 0 18px rgba(245, 193, 91, 0.8);
    }

    .btn--ghost {
      border-color: rgba(255, 255, 255, 0.22);
    }

    .btn--ghost:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.05);
      transform: translateY(-1px);
    }

    .btn--small {
      padding: 0.3rem 0.9rem;
      font-size: 0.8rem;
    }

    .btn-start-inline {
      margin-top: 0.6rem;
    }

    .answer-wrap {
      margin-top: 0.6rem;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .answer-input-row {
      display: flex;
      gap: 0.4rem;
      align-items: center;
    }

    /* veći, uočljiviji input */
    .answer-input-row input[type="text"] {
      flex: 1;
      border-radius: 16px;
      border: 2px solid rgba(255, 255, 255, 0.35);
      background: rgba(0, 0, 0, 0.65);
      padding: 0.65rem 1.1rem;
      color: var(--text-main);
      font-size: 1rem;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.7);
      outline: none;
    }

    .answer-input-row input[type="text"]::placeholder {
      color: rgba(255, 255, 255, 0.45);
    }

    .answer-input-row input[type="text"]:focus {
      border-color: rgba(245, 193, 91, 0.9);
      box-shadow: 0 0 18px rgba(245, 193, 91, 0.7);
    }

    .btn--icon {
      padding-inline: 1rem;
      font-size: 1.25rem;
    }

    .answer-feedback {
      font-size: 0.8rem;
      min-height: 1.1em;
    }

    .answer-feedback.correct {
      color: var(--accent-green);
    }

    .answer-feedback.incorrect {
      color: var(--accent-red);
    }

    .control-row {
      display: flex;
      justify-content: space-between;
      margin-top: 0.4rem;
      gap: 0.4rem;
      flex-wrap: wrap;
    }

    .control-row-left,
    .control-row-right {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
      align-items: center;
    }

    /* SIDEBAR – rezultati, povijest */

    .sidebar-card {
      background: var(--bg-card);
      border-radius: 18px;
      padding: 0.85rem 0.8rem;
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(14px);
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      max-height: 480px;
    }

    .sidebar-card h2 {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .score-summary {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
    }

    .score-summary-main {
      font-size: 1rem;
      font-weight: 600;
    }

    .score-summary-badges {
      display: flex;
      gap: 0.3rem;
      flex-wrap: wrap;
      font-size: 0.75rem;
    }

    .score-badge {
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(0, 0, 0, 0.5);
    }

    .score-badge--green {
      color: var(--accent-green);
      border-color: rgba(127, 217, 91, 0.7);
    }

    .score-badge--red {
      color: var(--accent-red);
      border-color: rgba(255, 107, 107, 0.7);
    }

    .history-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      overflow-y: auto;
      padding-right: 0.2rem;
      font-size: 0.78rem;
    }

    .history-item {
      border-radius: 10px;
      padding: 0.35rem 0.45rem;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(0, 0, 0, 0.5);
    }

    .history-item.correct {
      border-color: rgba(127, 217, 91, 0.6);
    }

    .history-item.incorrect {
      border-color: rgba(255, 107, 107, 0.6);
    }

    .history-q {
      font-weight: 500;
      margin-bottom: 0.1rem;
    }

    .history-meta {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 0.1rem;
    }

    .history-a {
      font-size: 0.76rem;
    }

    .history-a span.label {
      color: var(--text-muted);
    }

    /* FOOTER */

    .site-footer {
      text-align: center;
      padding: 0.9rem 0.9rem 1rem;
      font-size: 0.78rem;
      color: var(--text-muted);
      background: linear-gradient(180deg, transparent, rgba(0, 0, 0, 0.85));
      margin-top: 0.4rem;
    }

    .footer-copy {
      font-size: 0.76rem;
      color: var(--text-muted);
    }

    /* RESPONSIVE */

    @media (max-width: 900px) {
      .quiz-hero {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .site-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.45rem;
        padding: 0.7rem 0.7rem;
      }

      .top-nav {
        width: 100%;
        justify-content: flex-start;
        flex-wrap: wrap;
        row-gap: 0.35rem;
      }

      .page-wrap {
        padding: 0.7rem;
      }

      .quiz-main-grid {
        grid-template-columns: 1fr;
      }

      .sidebar-card {
        max-height: none;
      }
    }
  </style>
</head>
<body>
<header class="site-header">
  <div class="logo-wrap">
    <div class="logo-icon">
      <!-- koristi istu sliku loga kao i na glavnoj -->
      <img src="images/pub_kviz_logo.jpg" alt="Balkan Pub Quiz logo">
    </div>
    <div class="logo-text">
      <span class="logo-main">Balkanska Kviz Priča</span>
      <span class="logo-sub">Testiraj svoje znanje</span>
    </div>
  </div>
  <nav class="top-nav">
    <a href="index.html" class="nav-btn nav-btn--secondary">← Natrag na kartu</a>
    <a href="testiraj.html" class="nav-btn nav-btn--primary">Testiraj svoje znanje</a>
  </nav>
</header>

<main class="page-wrap">
  <!-- HERO / ODABIR MODA -->
  <section class="quiz-hero">
    <div>
      <h1 class="quiz-hero-main-title">Testiraj svoje znanje</h1>
      <p class="quiz-hero-subtitle">
        Blitz pitanja za brze reflekse ili duža, story pitanja za prave pub kviz znalce.
        Odaberi mod, pa započni kviz u prozoru s pitanjem.
      </p>

      <div class="quiz-hero-badges">
        <span class="badge badge--accent">Blitz 60s</span>
        <span class="badge badge--accent">Story 90s</span>
        <span class="badge badge--accent">Bez vremena</span>
        <span class="badge">Pitanja označena težinom 1–5</span>
      </div>

      <div class="mode-pills" id="mode-pills">
        <button class="mode-pill active" data-mode="blitz60">
          <span class="mode-label">Blitz 60s</span>
          <span class="mode-desc">jedno kratko pitanje za drugim</span>
        </button>
        <button class="mode-pill" data-mode="story90">
          <span class="mode-label">Story 90s</span>
          <span class="mode-desc">duža pitanja kao na pub kvizu</span>
        </button>
        <button class="mode-pill" data-mode="relax">
          <span class="mode-label">Bez vremena</span>
          <span class="mode-desc">random mix blitz + story</span>
        </button>
      </div>
    </div>

    <aside class="hero-right-card">
      <h3>Kako funkcionira?</h3>
      <ul class="hero-right-list">
        <li>Odaberi mod (Blitz 60s, Story 90s ili Bez vremena).</li>
        <li>Pitanja su označena težinom 1–5, ali dolaze pomiješano.</li>
        <li>U timed modovima vrijeme se jednom kratko pauzira kad kreneš pisati odgovor.</li>
        <li>Svaki odgovor označava se zeleno/crveno i bilježi u desni panel.</li>
        <li>Možeš preskočiti pitanje ako ne znaš odgovor.</li>
        <li>Kad vrijeme istekne, završavaš taj kviz i pokrećeš novi.</li>
      </ul>
    </aside>
  </section>

  <!-- GLAVNI KVIZ + SIDEBAR -->
  <section class="quiz-main-grid">
    <section class="quiz-card" id="quiz-card">
      <header class="quiz-card-header">
        <div class="quiz-card-title-block">
          <h2 class="quiz-card-title" id="quiz-title">Blitz kviz</h2>
          <p class="quiz-card-subtitle" id="quiz-mode-label">Brza pitanja u 60 sekundi</p>
        </div>
        <div class="timer-pill" id="timer-pill">
          <span class="timer-label">Vrijeme</span>
          <span class="timer-value" id="timer-value">60.0</span>
        </div>
      </header>

      <div class="question-container">
        <img src="" alt="" id="question-image" class="question-image" style="display:none;">
        <div class="question-text-wrap">
          <div class="question-text-label">Pitanje:</div>
          <div class="question-text" id="question-text">
            Klikni <strong>“Kreni s kvizom”</strong> ispod kako bi započeo igru.
          </div>
          <div class="question-meta" id="question-meta">
            <span id="question-type-label">Tip: —</span>
            <span class="difficulty-pill" id="question-difficulty-pill">Težina —/5</span>
          </div>
        </div>
      </div>

      <!-- START GUMB U ISTOM PROZORU KAO PITANJA -->
      <button class="btn btn--accent btn--small btn-start-inline" id="btn-start">
        Kreni s kvizom
      </button>

      <div class="answer-wrap">
        <div class="answer-input-row">
          <input type="text" id="answer-input" placeholder="Upiši svoj odgovor..." autocomplete="off">
          <button class="btn btn--accent btn--icon" id="btn-submit-answer" title="Potvrdi odgovor">✔</button>
        </div>
        <div class="answer-feedback" id="answer-feedback"></div>
      </div>

      <div class="control-row">
        <div class="control-row-left">
          <button class="btn btn--ghost btn--small" id="btn-skip">Preskoči pitanje</button>
        </div>
        <div class="control-row-right">
          <button class="btn btn--ghost btn--small" id="btn-reset">Reset kviza</button>
        </div>
      </div>
      <!-- status linija maknuta -->
    </section>

    <aside class="sidebar-card">
      <h2>Rezultati & povijest</h2>
      <div class="score-summary">
        <div>
          <div class="score-summary-main"><span id="score-correct">0</span>/<span id="score-total">0</span> točnih</div>
          <div style="font-size:0.75rem; color:var(--text-muted);" id="score-percent">0% uspješnosti</div>
        </div>
        <div class="score-summary-badges">
          <span class="score-badge score-badge--green">✓ <span id="score-correct-small">0</span></span>
          <span class="score-badge score-badge--red">✗ <span id="score-wrong-small">0</span></span>
        </div>
      </div>

      <ul class="history-list" id="history-list"></ul>
    </aside>
  </section>
</main>

<footer class="site-footer">
  <p class="footer-copy">
    © <span id="year"></span> Balkanska Kviz Priča – Testiraj svoje znanje.
  </p>
</footer>

<script>
  /* ------------------ GLOBAL STATE ------------------ */

  const QUESTIONS_URL_BLITZ = "questions-blitz.json";
  const QUESTIONS_URL_STORY = "questions-story.json";

  let ALL_QUESTIONS = [];
  let loadedBlitzCount = 0;
  let loadedStoryCount = 0;

  let currentMode = "blitz60"; // "blitz60" | "story90" | "relax"
  let currentQuestion = null;
  let usedQuestionIds = new Set();

  // za miksanje težina
  let lastDifficulty = null;
  let sameDifficultyStreak = 0;

  let timerDurationMs = 60000; // default 60s
  let remainingMs = 60000;
  let timerIntervalId = null;
  let timerRunning = false;
  let timerPausedForTyping = false;
  let typingPauseUntil = 0;
  let typingPauseUsedForCurrentQuestion = false;

  let scoreCorrect = 0;
  let scoreWrong = 0;
  let scoreTotal = 0;

  let quizFinished = false; // za timed modove kad istekne vrijeme

  /* ------------------ INIT ------------------ */

  document.addEventListener("DOMContentLoaded", async () => {
    initYear();
    initModeSwitch();
    initButtons();
    await loadQuestionsFromJson();
    updateModeLabel();
    updateScoreUI();
    setQuizInteractionEnabled(true);
    // više ne prikazujemo "Pitanja učitana..." na dnu
  });

  function initYear() {
    const y = document.getElementById("year");
    if (y) y.textContent = new Date().getFullYear();
  }

  /* ------------------ LOAD QUESTIONS (JSON) ------------------ */

  async function loadQuestionsFromJson() {
    const statusEl = document.getElementById("quiz-status-line"); // element ne postoji, ali ovo ne smeta

    try {
      const [respBlitz, respStory] = await Promise.all([
        fetch(QUESTIONS_URL_BLITZ),
        fetch(QUESTIONS_URL_STORY)
      ]);

      if (!respBlitz.ok || !respStory.ok) {
        throw new Error("Greška pri čitanju JSON datoteka.");
      }

      const blitzData = await respBlitz.json();
      const storyData = await respStory.json();

      if (!Array.isArray(blitzData) || !Array.isArray(storyData)) {
        throw new Error("JSON format nije ispravan (očekuje se lista).");
      }

      const normalizedBlitz = blitzData.map((q, idx) => ({
        id: q.id ?? "blitz-" + idx,
        type: q.type || "blitz",
        difficulty: typeof q.difficulty === "number" ? q.difficulty : 1,
        question: q.question || "",
        answers: Array.isArray(q.answers) ? q.answers : [],
        image: q.image || null
      }));

      const normalizedStory = storyData.map((q, idx) => ({
        id: q.id ?? "story-" + idx,
        type: q.type || "story",
        difficulty: typeof q.difficulty === "number" ? q.difficulty : 1,
        question: q.question || "",
        answers: Array.isArray(q.answers) ? q.answers : [],
        image: q.image || null
      }));

      ALL_QUESTIONS = [...normalizedBlitz, ...normalizedStory];
      loadedBlitzCount = normalizedBlitz.length;
      loadedStoryCount = normalizedStory.length;

      if (statusEl) {
        statusEl.textContent =
          "Učitano " +
          loadedBlitzCount +
          " blitz pitanja i " +
          loadedStoryCount +
          " story pitanja.";
      }
    } catch (err) {
      console.error("Greška pri učitavanju pitanja:", err);
      if (statusEl) {
        statusEl.textContent =
          "Ne možemo učitati pitanja. Provjeri JSON datoteke (questions-blitz.json, questions-story.json).";
      }
    }
  }

  /* ------------------ MODE ------------------ */

  function initModeSwitch() {
    const pills = document.querySelectorAll(".mode-pill");
    pills.forEach((pill) => {
      pill.addEventListener("click", () => {
        const mode = pill.getAttribute("data-mode");
        if (!mode || mode === currentMode) return;
        currentMode = mode;

        pills.forEach((p) => p.classList.toggle("active", p === pill));

        stopTimer();
        resetTimerForMode();
        usedQuestionIds.clear();
        typingPauseUsedForCurrentQuestion = false;
        quizFinished = false;
        lastDifficulty = null;
        sameDifficultyStreak = 0;
        setQuizInteractionEnabled(true);

        updateModeLabel();
      });
    });
  }

  function resetTimerForMode() {
    if (currentMode === "blitz60") {
      timerDurationMs = 60000;
    } else if (currentMode === "story90") {
      timerDurationMs = 90000;
    } else {
      timerDurationMs = 0; // bez vremena
    }
    remainingMs = timerDurationMs;
    updateTimerUI();
  }

  function updateModeLabel() {
    const subtitleEl = document.getElementById("quiz-mode-label");
    const titleEl = document.getElementById("quiz-title");
    if (!subtitleEl || !titleEl) return;

    let titleText = "";
    let subtitleText = "";

    if (currentMode === "blitz60") {
      titleText = "Blitz kviz";
      subtitleText = "Brza pitanja u 60 sekundi";
    } else if (currentMode === "story90") {
      titleText = "Story kviz";
      subtitleText = "Duže priče i pitanja u 90 sekundi";
    } else {
      titleText = "Bezvremenski kviz";
      subtitleText = "Opušteni mix blitz + story bez ograničenja";
    }

    titleEl.textContent = titleText;
    subtitleEl.textContent = subtitleText;
  }

  /* ------------------ GUMBI ------------------ */

  function initButtons() {
    const btnStart = document.getElementById("btn-start");
    const btnSubmit = document.getElementById("btn-submit-answer");
    const btnSkip = document.getElementById("btn-skip");
    const btnReset = document.getElementById("btn-reset");
    const answerInput = document.getElementById("answer-input");

    if (btnStart) {
      btnStart.addEventListener("click", () => {
        // novi kviz svaki put kad klikneš
        startNewRound(isTimedMode());
      });
    }

    if (btnSubmit && answerInput) {
      btnSubmit.addEventListener("click", () => {
        handleSubmitAnswer();
      });

      answerInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          handleSubmitAnswer();
          return;
        }

        if (!typingPauseUsedForCurrentQuestion && isTimedMode() && !quizFinished) {
          typingPauseUsedForCurrentQuestion = true;
          pauseTimerForTyping();
        }
      });
    }

    if (btnSkip) {
      btnSkip.addEventListener("click", () => {
        if (isTimedMode() && quizFinished) {
          return;
        }
        if (!currentQuestion) {
          return;
        }
        logAnswerHistory("", false, true);
        loadNextQuestion();
      });
    }

    if (btnReset) {
      btnReset.addEventListener("click", () => {
        resetQuiz();
      });
    }
  }

  function setQuizInteractionEnabled(enabled) {
    const answerInput = document.getElementById("answer-input");
    const btnSubmit = document.getElementById("btn-submit-answer");
    const btnSkip = document.getElementById("btn-skip");
    if (answerInput) answerInput.disabled = !enabled;
    if (btnSubmit) btnSubmit.disabled = !enabled;
    if (btnSkip) btnSkip.disabled = !enabled;
    // btn-start ostaje uvijek aktivan
  }

  /* ------------------ ROUND MANAGEMENT ------------------ */

  function startNewRound(startTimerAlso) {
    usedQuestionIds.clear();
    scoreCorrect = 0;
    scoreWrong = 0;
    scoreTotal = 0;
    quizFinished = false;
    lastDifficulty = null;
    sameDifficultyStreak = 0;
    updateScoreUI();
    clearHistoryList();
    stopTimer();
    resetTimerForMode();
    typingPauseUsedForCurrentQuestion = false;
    setQuizInteractionEnabled(true);

    loadNextQuestion();

    if (startTimerAlso && isTimedMode()) {
      startTimer();
    } else {
      stopTimer();
    }
  }

  function isTimedMode() {
    return currentMode === "blitz60" || currentMode === "story90";
  }

  function loadNextQuestion() {
    if (isTimedMode() && quizFinished) {
      return;
    }

    const pool = getQuestionPoolForCurrentMode();

    if (!pool.length) {
      return;
    }

    const available = pool.filter(q => !usedQuestionIds.has(q.id));

    // --- pametnije miješanje težina ---
    let candidates = (available.length ? available : pool).slice();

    const ld = (typeof lastDifficulty === "number") ? lastDifficulty : null;
    if (ld !== null && sameDifficultyStreak >= 2) {
      const alt = candidates.filter(q => typeof q.difficulty === "number" && q.difficulty !== ld);
      if (alt.length) {
        candidates = alt;
      }
    }

    const chosen = candidates[Math.floor(Math.random() * candidates.length)];

    currentQuestion = chosen;
    usedQuestionIds.add(chosen.id);

    // update streak težine
    if (typeof chosen.difficulty === "number") {
      if (lastDifficulty === chosen.difficulty) {
        sameDifficultyStreak++;
      } else {
        lastDifficulty = chosen.difficulty;
        sameDifficultyStreak = 1;
      }
    } else {
      lastDifficulty = null;
      sameDifficultyStreak = 0;
    }

    typingPauseUsedForCurrentQuestion = false;
    timerPausedForTyping = false;
    typingPauseUntil = 0;

    updateQuestionUI(chosen);
    clearAnswerField();
  }

  function getQuestionPoolForCurrentMode() {
    // nema filtriranja po težini – sva pitanja mogu izaći
    return ALL_QUESTIONS.filter(q => {
      if (!q || !q.question || !Array.isArray(q.answers)) return false;

      if (currentMode === "blitz60") return q.type === "blitz";
      if (currentMode === "story90") return q.type === "story";
      return q.type === "blitz" || q.type === "story";
    });
  }

  /* ------------------ UI UPDATE – QUESTION ------------------ */

  function updateQuestionUI(q) {
    const questionTextEl = document.getElementById("question-text");
    const typeLabelEl = document.getElementById("question-type-label");
    const diffPillEl = document.getElementById("question-difficulty-pill");
    const imgEl = document.getElementById("question-image");
    const feedbackEl = document.getElementById("answer-feedback");

    if (questionTextEl) {
      questionTextEl.textContent = q.question || "(prazno pitanje)";
    }

    if (typeLabelEl) {
      let label = q.type === "blitz" ? "Tip: Blitz" : "Tip: Story";
      typeLabelEl.textContent = label;
    }

    if (diffPillEl) {
      const d = typeof q.difficulty === "number" ? q.difficulty : "—";
      diffPillEl.textContent = "Težina " + d + "/5";
    }

    if (imgEl) {
      if (q.image) {
        imgEl.src = q.image;
        imgEl.alt = "Vizualna pomoć za pitanje";
        imgEl.style.display = "block";
      } else {
        imgEl.src = "";
        imgEl.alt = "";
        imgEl.style.display = "none";
      }
    }

    if (feedbackEl) {
      feedbackEl.textContent = "";
      feedbackEl.classList.remove("correct", "incorrect");
    }
  }

  function clearAnswerField() {
    const input = document.getElementById("answer-input");
    if (input) {
      input.value = "";
      input.focus();
    }
  }

  /* ------------------ TIMER ------------------ */

  function startTimer() {
    if (!isTimedMode()) return;

    stopTimer();
    timerRunning = true;
    timerPausedForTyping = false;
    typingPauseUntil = 0;
    quizFinished = false;

    const startTime = performance.now();
    let lastTime = startTime;

    timerIntervalId = requestAnimationFrame(function tick(now) {
      if (!timerRunning) return;

      if (timerPausedForTyping) {
        if (now >= typingPauseUntil) {
          timerPausedForTyping = false;
        } else {
          updateTimerUI();
          timerIntervalId = requestAnimationFrame(tick);
          return;
        }
      }

      const delta = now - lastTime;
      lastTime = now;

      remainingMs -= delta;
      if (remainingMs <= 0) {
        remainingMs = 0;
        updateTimerUI();
        timerRunning = false;
        quizFinished = true;
        currentQuestion = null;
        setQuizInteractionEnabled(false);
        return;
      }

      updateTimerUI();
      timerIntervalId = requestAnimationFrame(tick);
    });
  }

  function stopTimer() {
    timerRunning = false;
    if (timerIntervalId) {
      cancelAnimationFrame(timerIntervalId);
      timerIntervalId = null;
    }
  }

  function pauseTimerForTyping() {
    if (!isTimedMode()) return;
    if (!timerRunning) return;

    timerPausedForTyping = true;
    typingPauseUntil = performance.now() + 2000; // 2s
  }

  function forceResumeTimerFromTyping() {
    if (!isTimedMode()) return;
    if (timerPausedForTyping) {
      timerPausedForTyping = false;
      typingPauseUntil = 0;
    }
  }

  function updateTimerUI() {
    const valEl = document.getElementById("timer-value");
    const pill = document.getElementById("timer-pill");
    if (!valEl || !pill) return;

    if (!isTimedMode()) {
      pill.style.opacity = 0.35;
      valEl.textContent = "∞";
      return;
    }

    pill.style.opacity = 1;
    const seconds = remainingMs / 1000;
    valEl.textContent = seconds.toFixed(1);
  }

  /* ------------------ ANSWERS, FUZZY MATCH ------------------ */

  function handleSubmitAnswer() {
    if (isTimedMode() && quizFinished) {
      return;
    }

    if (!currentQuestion) {
      return;
    }

    const input = document.getElementById("answer-input");
    const feedbackEl = document.getElementById("answer-feedback");
    if (!input || !feedbackEl) return;

    const userAnswerRaw = input.value.trim();
    if (!userAnswerRaw) {
      return;
    }

    forceResumeTimerFromTyping();

    const isCorrect = checkAnswer(currentQuestion, userAnswerRaw);

    scoreTotal++;
    if (isCorrect) {
      scoreCorrect++;
    } else {
      scoreWrong++;
    }
    updateScoreUI();
    logAnswerHistory(userAnswerRaw, isCorrect, false);

    feedbackEl.textContent = isCorrect ? "Točno! ✅" : "Netočno. ❌";
    feedbackEl.classList.toggle("correct", isCorrect);
    feedbackEl.classList.toggle("incorrect", !isCorrect);

    setTimeout(() => {
      if (isTimedMode() && quizFinished) {
        // vrijeme je možda isteklo u međuvremenu
        return;
      }
      loadNextQuestion();
    }, 600);
  }

  function normalizeText(str) {
    return (str || "")
      .toString()
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "") // dijakritika
      .replace(/[^a-z0-9]+/g, "")      // sve osim slova i brojeva
      .trim();
  }

  function levenshtein(a, b) {
    if (a === b) return 0;
    const lenA = a.length;
    const lenB = b.length;
    if (lenA === 0) return lenB;
    if (lenB === 0) return lenA;

    const dp = new Array(lenB + 1);
    for (let j = 0; j <= lenB; j++) {
      dp[j] = j;
    }

    for (let i = 1; i <= lenA; i++) {
      let prev = dp[0];
      dp[0] = i;
      for (let j = 1; j <= lenB; j++) {
        const tmp = dp[j];
        const cost = a[i - 1] === b[j - 1] ? 0 : 1;
        dp[j] = Math.min(
          dp[j] + 1,
          dp[j - 1] + 1,
          prev + cost
        );
        prev = tmp;
      }
    }
    return dp[lenB];
  }

  function checkAnswer(question, userAnswer) {
    const normalizedUser = normalizeText(userAnswer);
    const answers = Array.isArray(question.answers) ? question.answers : [];
    if (!answers.length) return false;

    for (const ans of answers) {
      const normalizedAns = normalizeText(ans);
      if (!normalizedAns) continue;

      if (normalizedUser === normalizedAns) return true;

      const dist = levenshtein(normalizedUser, normalizedAns);
      if (normalizedAns.length <= 5 && dist <= 1) return true;
      if (normalizedAns.length > 5 && dist <= 2) return true;

      if (normalizedUser.includes(normalizedAns) && normalizedAns.length >= 4) {
        return true;
      }
    }

    return false;
  }

  /* ------------------ SCORE & HISTORY UI ------------------ */

  function updateScoreUI() {
    const c = document.getElementById("score-correct");
    const t = document.getElementById("score-total");
    const cSmall = document.getElementById("score-correct-small");
    const wSmall = document.getElementById("score-wrong-small");
    const percentEl = document.getElementById("score-percent");

    if (c) c.textContent = scoreCorrect;
    if (t) t.textContent = scoreTotal;
    if (cSmall) cSmall.textContent = scoreCorrect;
    if (wSmall) wSmall.textContent = scoreWrong;

    let percent = 0;
    if (scoreTotal > 0) {
      percent = Math.round((scoreCorrect / scoreTotal) * 100);
    }
    if (percentEl) {
      percentEl.textContent = percent + "% uspješnosti";
    }
  }

  function logAnswerHistory(userAnswer, isCorrect, skipped) {
    const list = document.getElementById("history-list");
    if (!list || !currentQuestion) return;

    const li = document.createElement("li");
    li.className = "history-item " + (skipped ? "incorrect" : (isCorrect ? "correct" : "incorrect"));

    const qDiv = document.createElement("div");
    qDiv.className = "history-q";
    qDiv.textContent = currentQuestion.question || "(pitanje)";

    const metaDiv = document.createElement("div");
    metaDiv.className = "history-meta";
    const typeLabel = currentQuestion.type === "blitz" ? "Blitz" : "Story";
    const diffText = "Težina " + (currentQuestion.difficulty ?? "—") + "/5";
    metaDiv.innerHTML = `<span>${typeLabel}</span><span>${diffText}</span>`;

    const aDiv = document.createElement("div");
    aDiv.className = "history-a";

    const answers = currentQuestion.answers || [];
    const mainAnswer = answers[0] || "(nema odgovora)";

    if (skipped) {
      aDiv.innerHTML =
        `<span class="label">Preskočeno.</span> Točan odgovor: <strong>${mainAnswer}</strong>`;
    } else if (isCorrect) {
      aDiv.innerHTML =
        `<span class="label">Tvoj odgovor:</span> ${userAnswer || "(prazno)"}<br>` +
        `<span class="label">Točno ✔</span>`;
    } else {
      aDiv.innerHTML =
        `<span class="label">Tvoj odgovor:</span> ${userAnswer || "(prazno)"}<br>` +
        `<span class="label">Točan odgovor:</span> <strong>${mainAnswer}</strong>`;
    }

    li.appendChild(qDiv);
    li.appendChild(metaDiv);
    li.appendChild(aDiv);

    list.prepend(li);
  }

  function clearHistoryList() {
    const list = document.getElementById("history-list");
    if (list) list.innerHTML = "";
  }

  /* ------------------ RESET ------------------ */

  function resetQuiz() {
    stopTimer();
    resetTimerForMode();
    currentQuestion = null;
    usedQuestionIds.clear();
    typingPauseUsedForCurrentQuestion = false;
    lastDifficulty = null;
    sameDifficultyStreak = 0;

    scoreCorrect = 0;
    scoreWrong = 0;
    scoreTotal = 0;
    quizFinished = false;

    updateScoreUI();
    clearHistoryList();
    setQuizInteractionEnabled(true);

    const questionTextEl = document.getElementById("question-text");
    const typeLabelEl = document.getElementById("question-type-label");
    const diffPillEl = document.getElementById("question-difficulty-pill");
    const imgEl = document.getElementById("question-image");
    const feedbackEl = document.getElementById("answer-feedback");
    const input = document.getElementById("answer-input");

    if (questionTextEl) {
      questionTextEl.innerHTML = 'Kviz je resetiran. Odaberi mod i klikni <strong>“Kreni s kvizom”</strong>.';
    }
    if (typeLabelEl) {
      typeLabelEl.textContent = "Tip: —";
    }
    if (diffPillEl) {
      diffPillEl.textContent = "Težina —/5";
    }
    if (imgEl) {
      imgEl.src = "";
      imgEl.style.display = "none";
    }
    if (feedbackEl) {
      feedbackEl.textContent = "";
      feedbackEl.classList.remove("correct", "incorrect");
    }
    if (input) {
      input.value = "";
    }
  }
</script>
</body>
</html>
